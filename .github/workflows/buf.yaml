name: buf

on:
  pull_request:
    branches: [master]

# Declare default permissions as read only.
permissions: read-all

jobs:
  lint:
    name: lint
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      pull-requests: write
    steps:
      - uses: actions/checkout@f43a0e5ff2bd294095638e18286ca9a3d1956744 # v3

      - uses: bufbuild/buf-setup-action@1158f4fa81bc02e1ff62abcca6d516c9e24c77da # v1.27.2
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: check formatting
        working-directory: src/Vfps
        run: buf format --exit-code

      - uses: bufbuild/buf-lint-action@044d13acb1f155179c606aaa2e53aea304d22058 # v1.1.0
        with:
          input: src/Vfps
      # Doesn't currently work due to the weird file setup. Fails with:
      # Error: Protos/vfps/api/v1/meta.proto: does not exist
      # Error: Protos/vfps/api/v1/meta.proto: does not exist
      # Error: google/api/http.proto: does not exist
      # Error: buf found 3 breaking changes.
      # - uses: bufbuild/buf-breaking-action@1cd949a5f7c5581990772f1e0c8a5270d7e4401b # tag=v1.1.1
      #   with:
      #     input: src/Vfps
      #     against: "https://github.com/${{ github.repository }}.git#branch=master"
